# Requirements
# iheatmapr, plotly

# These are the inputs required: these are identical to 
# the input taken by TCGAMAFVisualise oncoprint function

# mut <- top.mut.data
# genes <- top.mut.genes
# annotation <- joined.clin.data.banded

# The oncomatic_oncoprint function defined, this can be called in other scripts
# with source("oncomatic_oncoprint_script")

oncomatic_oncoprint <- function (mut,
                                 genes,
                                 annotation
                                 ){
  # The first step is preparing the data table from mut file input 
  # This using the TCGA_MAFvisualise_Oncoprint code

  mut <- setDT(mut)
  str(mut)
  mut$value <- 1
  all.samples <- unique(mut$Tumor_Sample_Barcode)

  #mut$Hugo_Symbol <- as.character(mut$Hugo_Symbol)
  #if(!missing(genes) & !is.null(genes)) mut <- subset(mut, mut$Hugo_Symbol %in% genes)

  

  formula <- paste0("Tumor_Sample_Barcode + Hugo_Symbol ~ Variant_Type")
  suppressMessages({mat <- dcast(mut, as.formula(formula),value.var = "value",fill = 0,drop = FALSE)})

  columns <- colnames(mat)[-c(1:2)]

  mat$value <- ""
  mat <- setDT(mat)
  for ( i in columns){
      mat[,i] <-  replace(mat[,i,with = FALSE],mat[,i,with = FALSE]>0,paste0(i,";"))
      mat[,i] <-  replace(mat[,i,with = FALSE],mat[,i,with = FALSE]==0,"")
      mat[,value:=paste0(value,get(i))]
  }
  str(mat)

  mutation.type <- c()
  for (i in columns){
      if(length(grep(i,mat$value)) > 0) mutation.type <- c(mutation.type,i)
  }

  mat <- setDF(dcast(mat, Tumor_Sample_Barcode~Hugo_Symbol, value.var="value",fill=""))
      rownames(mat) <- mat[,1]
      mat <- mat[,-1]

 
  aux <- data.frame(row.names = all.samples[!all.samples %in% rownames(mat)])
  if(nrow(aux) > 0) {
      aux[,colnames(mat)] <- ""
      mat <- rbind(mat,aux)
  }
      

  mat <- t(mat)

  idx <- match(substr(colnames(mat),1,12),annotation$bcr_patient_barcode)
  annotation <- annotation[idx,]
  annotation$bcr_patient_barcode <- NULL

  collumn.names <- c("race","gender","vital_status","tumor_stage")

  annotation <- annotation[collumn.names]

  annotation <- t(annotation)

  annotation <- as.data.frame(annotation)

  mat <- as.data.frame(mat)

  mat.colnams <- colnames(mat)

  colnames(annotation) <- mat.colnams

  temp.matrix <- rbind(mat, annotation)
  temp.matrix <- as.matrix(temp.matrix)

  # turn temp.matrix matrix into a usable numbered tumor.matrix
  
  # these steps turn the MAF mutaton string values into numbers
  # so INS; becomes '2' and so on
  # The below steps must be in this exact order
  # otherwise all instances of INS; including
  # INS; in INS; SNP; will be changed resulting in '21' instead of '4'
  step.1 <- gsub("INS;DEL;SNP;", "6", temp.matrix)

  step.2 <- gsub("INS;SNP;", "4", step.1)

  step.3 <- gsub("DEL;SNP;", "5", step.2)

  step.4 <- gsub("SNP;", "1", step.3)


  step.5 <- gsub("INS;", "2", step.4)


  step.6 <- gsub("DEL;", "3", step.5)

  step.6[step.6 == ""] <- 0

  step.6

  tumor.matrix.df <- as.data.frame(step.6)

  newnames <- NULL
  for(i in names(tumor.matrix.df)){
    part.1 <- tumor.matrix.df[[paste(i)]]
    part.2 <- levels(part.1)
    part.3 <- paste(toString(part.2), sep="")
    part.4 <- c(i,part.3)
    part.5 <- toString(part.4)
    newnames <- c(newnames,part.5)
  }

  colnames(tumor.matrix.df) <- newnames

  tumor.matrix.df

  remove.these <- c("race","gender","vital_status","tumor_stage")
  tumor.matrix <- tumor.matrix.df[!rownames(tumor.matrix.df) %in% remove.these,]

  tumor.matrix[] <- lapply(tumor.matrix, function(x) as.numeric(as.character(x)))

  # Now we have created a usable matrix of samples and mutations as respective numbers
  tumor.matrix <- as.matrix(tumor.matrix)
  str(tumor.matrix) 

col.number <- ncol(tumor.matrix)


# now ordering the matrix from highest mutations to lowest

top.genes.list <- rev(top.mut.genes)
tumor.matrix <- tumor.matrix[top.genes.list, ]



  # Here we are creating the values for the clinical heatmaps
  
  #race
  white.pos <- grep('white', colnames(tumor.matrix))
  white.patients <- colnames(tumor.matrix)[white.pos]

  black.pos <- grep('black', colnames(tumor.matrix))
  black.patients <- colnames(tumor.matrix)[black.pos]

  asian.pos <- grep('asian', colnames(tumor.matrix))
  asian.patients <- colnames(tumor.matrix)[asian.pos]



  #gender
  female.pos <- grep('female', colnames(tumor.matrix))
  female.patients <- colnames(tumor.matrix)[female.pos]

  male.pos <- grep(' male', colnames(tumor.matrix))
  male.patients <- colnames(tumor.matrix)[male.pos]

  #status
  alive.pos <- grep('alive', colnames(tumor.matrix))
  alive.patients <- colnames(tumor.matrix)[alive.pos]

  dead.pos <- grep('dead', colnames(tumor.matrix))
  dead.patients <- colnames(tumor.matrix)[dead.pos]



  ## cancer stage 
  si.pos <- grep(' stage i,', colnames(tumor.matrix))
  si.patients <- colnames(tumor.matrix)[si.pos]

  sii.pos <- grep(' stage ii,', colnames(tumor.matrix))
  sii.patients <- colnames(tumor.matrix)[sii.pos]

  siii.pos <- grep(' stage iii,', colnames(tumor.matrix))
  siii.patients <- colnames(tumor.matrix)[siii.pos]

  siv.pos <- grep(' stage iv,', colnames(tumor.matrix))
  siv.patients <- colnames(tumor.matrix)[siv.pos]


  # Here we are creating the barplots for the numbers of patients and mutated genes respectively
  
  # number of mutated patient samples per gene
  test = as.numeric();
  for (i in 1:nrow(tumor.matrix)) {
    test[i] <- sum(tumor.matrix[i,] > 0)
  }
  print(test);

  # number of mutated genes per patient sample
  test2 = as.numeric();
  for (i in 1:ncol(tumor.matrix)) {
    test2[i] <- sum(tumor.matrix[,i] > 0)
  }
  print(test2);



  # Now we create the plot using the input mutations matrix and the heatmaps
  main_heatmap(tumor.matrix, name = "Mutations<br>Profile", x_categorical = TRUE,
                colors= c("white", "red", "blue", "green")) %>%
  add_col_groups(
    ifelse(colnames(tumor.matrix) %in% white.patients,
          "White", 
          ifelse(colnames(tumor.matrix) %in% black.patients,
                 "Black", 
                 ifelse(colnames(tumor.matrix) %in% asian.patients,
                        "Asian",
                        "Not Reported"))),
                    side = "bottom", name = "Sample<br>Race",
                    title = "Race",
                    colors = c('#ea4335','#fbbc05','grey','#4285f4')) %>%
  add_col_groups(
    ifelse(colnames(tumor.matrix) %in% female.patients,
          "female",  
          ifelse(colnames(tumor.matrix) %in% male.patients,
          "male",  
                        "Not Reported")),
                    side = "bottom", name = "Sample<br>Gender",
                    title = "Gender",
                    colors = c("pink", "grey", "blue")) %>%
  add_col_groups(
    ifelse(colnames(tumor.matrix) %in% alive.patients,
          "Alive",  
          ifelse(colnames(tumor.matrix) %in% dead.patients,
                        "Dead", 
                        "Not Reported")),
                    side = "bottom", name = "Sample<br>Status",
                    title = "Status",
                    colors = c("green","black", "grey")) %>%
  add_col_groups(
    ifelse(colnames(tumor.matrix) %in% si.patients,
          "Stage i",  
          ifelse(colnames(tumor.matrix) %in% sii.patients,
                        "Stage ii",
            ifelse(colnames(tumor.matrix) %in% siii.patients,
                        "Stage iii",
                  ifelse(colnames(tumor.matrix) %in% siv.patients,
                        "Stage iv",
                        "Not Reported")))),
                    side = "bottom", name = "Sample<br>Cancer<br>Stage",
                    title = "Status", 
                    colors = c("grey","#0084ff","#94ce08","#f5dc00", "orange")) %>%
    add_col_labels(ticktext = colnames(tumor.matrix), font = list(size = 8)) %>%
    add_row_labels(size = 0.3,font = list(size = 20), side="left") %>%               
    add_col_title("TCGA Clinical Patient Samples", side= "top", font = list(size = 15)) %>%
    add_row_barplot(x = test, color="maroon",
                    tracename = "No. of patient samples presenting mutation in this gene", 
                    layout = list(title = "No. of <br>Samples<br>Presenting <br>Mutated Gene")) %>%
    add_col_barplot(y = test2, color="#F4A460",
                  tracename = "No. of genes mutated for this patient sample", 
                  layout = list(title = "Number of <br>Mutated Genes<br>Per Sample"))
}
